<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <!-- SheetJS for Excel reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <title>√áok Katlƒ± Navigasyon</title>
    <style>
        /* Satƒ±r d√ºzeni: Kat + Birim aynƒ± satƒ±rda */
        .selection-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: flex-end;
        }
        .selection-row .floor-group {
            flex: 0 0 100px;
            min-width: 0;
        }
        .selection-row .room-group {
            flex: 1;
            min-width: 0;
        }
        .selection-row label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
            color: #555;
            white-space: nowrap;
        }
        .selection-row select {
            width: 100%;
            padding: 10px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            box-sizing: border-box;
        }
        
        /* Mobil i√ßin daha dar kat se√ßici */
        @media (max-width: 480px) {
            .selection-row {
                gap: 8px;
            }
            .selection-row .floor-group {
                flex: 0 0 80px;
            }
            .selection-row select {
                padding: 8px 6px;
                font-size: 13px;
            }
            .selection-row label {
                font-size: 11px;
            }
        }
        
        .floor-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
            background: #e0e0e0;
        }
        .floor-badge.floor-0 { background: #4CAF50; color: white; }
        .floor-badge.floor--1 { background: #2196F3; color: white; }
        .floor-badge.floor--2 { background: #FF9800; color: white; }
        
        .route-preview {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        .route-preview.show { display: block; }
        .route-preview h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .route-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        .route-step:last-child { border-bottom: none; }
        .route-step .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }
        .route-step .step-icon.start { background: #4CAF50; color: white; }
        .route-step .step-icon.portal { background: #FF9800; color: white; }
        .route-step .step-icon.end { background: #f44336; color: white; }
        .route-step .step-text {
            flex: 1;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-overlay.hidden { display: none; }
        .loading-spinner {
            text-align: center;
        }
        .loading-spinner .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div>Haritalar y√ºkleniyor...</div>
        </div>
    </div>

    <h2 style="text-align: center; margin-bottom: 20px;">üè¢ √áok Katlƒ± Navigasyon</h2>

    <!-- Bina Se√ßimi -->
    <div class="input-group" style="margin-bottom: 15px;">
        <label for="buildingSelect">üè¨ Bina Se√ßin:</label>
        <select id="buildingSelect">
            <option value="">-- Bina Se√ßin --</option>
            <option value="zorlu">Zorlu Center</option>
            <option value="ISG">ƒ∞SG</option>
        </select>
    </div>

    <!-- Ba≈ülangƒ±√ß: Kat + Birim aynƒ± satƒ±rda -->
    <div class="selection-row">
        <div class="floor-group">
            <label for="startFloor">Kat:</label>
            <select id="startFloor">
                <option value="">--</option>
            </select>
        </div>
        <div class="room-group">
            <label for="startRoom">Ba≈ülangƒ±√ß Birimi:</label>
            <select id="startRoom">
                <option value="">-- √ñnce kat se√ßin --</option>
            </select>
        </div>
    </div>

    <!-- Hedef: Kat + Birim aynƒ± satƒ±rda -->
    <div class="selection-row">
        <div class="floor-group">
            <label for="endFloor">Kat:</label>
            <select id="endFloor">
                <option value="">--</option>
            </select>
        </div>
        <div class="room-group">
            <label for="endRoom">Hedef Birimi:</label>
            <select id="endRoom">
                <option value="">-- √ñnce kat se√ßin --</option>
            </select>
        </div>
    </div>

    <!-- Rota √ñnizleme -->
    <div class="route-preview" id="routePreview">
        <h4>üìç Rota √ñzeti</h4>
        <div id="routeSteps"></div>
    </div>

    <div class="button-container">
        <a href="#" class="ar-button" id="ar-button">
            <span class="material-symbols-outlined">
                flip
            </span>
            AR Navigasyonu Ba≈ülat
        </a>
    </div>

    <script src="./map-direction.js"></script>
    <script>
        let mapDirection = null;
        let excelData = {}; // { floorId: { roomId: { title, subtitle } } }
        let currentRoute = null;
        let currentBuilding = null; // Se√ßili bina

        document.addEventListener('DOMContentLoaded', async function() {
            mapDirection = new MapDirection();
            
            // Ba≈ülangƒ±√ßta loading'i gizle
            document.getElementById('loadingOverlay').classList.add('hidden');
            
            // Bina se√ßimi event listener'ƒ±
            document.getElementById('buildingSelect').addEventListener('change', onBuildingChange);
            
            // Event listener'lar
            document.getElementById('startFloor').addEventListener('change', onStartFloorChange);
            document.getElementById('endFloor').addEventListener('change', onEndFloorChange);
            document.getElementById('startRoom').addEventListener('change', updateRoutePreview);
            document.getElementById('endRoom').addEventListener('change', updateRoutePreview);
        });
        
        async function onBuildingChange() {
            const buildingSelect = document.getElementById('buildingSelect');
            const building = buildingSelect.value;
            
            if (!building) {
                // Bina se√ßilmemi≈üse dropdown'larƒ± temizle
                currentBuilding = null;
                document.getElementById('startFloor').innerHTML = '<option value="">--</option>';
                document.getElementById('endFloor').innerHTML = '<option value="">--</option>';
                document.getElementById('startRoom').innerHTML = '<option value="">-- √ñnce bina se√ßin --</option>';
                document.getElementById('endRoom').innerHTML = '<option value="">-- √ñnce bina se√ßin --</option>';
                document.getElementById('routePreview').classList.remove('show');
                return;
            }
            
            // Loading g√∂ster
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            try {
                currentBuilding = building;
                
                // Yeni MapDirection olu≈ütur
                mapDirection = new MapDirection();
                
                // Se√ßilen bina i√ßin katlarƒ± y√ºkle
                await mapDirection.loadAllFloors(`./${building}`);
                await loadExcelData(building);
                
                // Kat dropdown'larƒ±nƒ± doldur
                populateFloorSelects();
                
                // Oda dropdown'larƒ±nƒ± sƒ±fƒ±rla
                document.getElementById('startRoom').innerHTML = '<option value="">-- √ñnce kat se√ßin --</option>';
                document.getElementById('endRoom').innerHTML = '<option value="">-- √ñnce kat se√ßin --</option>';
                
                // Rota √∂nizlemeyi gizle
                document.getElementById('routePreview').classList.remove('show');
                
                document.getElementById('loadingOverlay').classList.add('hidden');
                console.log(`${building} binasƒ± y√ºklendi`);
            } catch (e) {
                console.error('Bina y√ºkleme hatasƒ±:', e);
                document.getElementById('loadingOverlay').classList.add('hidden');
                alert(`${building} binasƒ± y√ºklenemedi: ${e.message}`);
            }
        }
            
        // AR butonu
        document.getElementById('ar-button').addEventListener('click', function(event) {
            event.preventDefault();
            
            const startFloor = document.getElementById('startFloor').value;
            const endFloor = document.getElementById('endFloor').value;
            const startRoom = document.getElementById('startRoom').value;
            const endRoom = document.getElementById('endRoom').value;
            
            if (!currentBuilding) {
                alert('L√ºtfen √∂nce bir bina se√ßin!');
                return;
            }
            
            if (!startFloor || !endFloor || !startRoom || !endRoom) {
                alert('L√ºtfen t√ºm alanlarƒ± doldurun!');
                return;
            }
            
            if (startFloor === endFloor && startRoom === endRoom) {
                alert('Ba≈ülangƒ±√ß ve hedef aynƒ± olamaz!');
                return;
            }
            
            // √áoklu kat rotasƒ± hesapla
            const route = mapDirection.calculateMultiFloorRoute(startRoom, startFloor, endRoom, endFloor);
            
            if (!route) {
                alert('Rota hesaplanamadƒ±!');
                return;
            }
            
            console.log('Hesaplanan rota:', route);
            
            // Rota bilgilerini encode et
            const routeData = encodeURIComponent(JSON.stringify(route));
            
            // AR sayfasƒ±na y√∂nlendir (bina bilgisi ile)
            const params = new URLSearchParams({
                routeData: routeData,
                startRoom: startRoom,
                endRoom: endRoom,
                startFloor: startFloor,
                endFloor: endFloor,
                building: currentBuilding
            });
            
            window.location.href = `ar.html?${params.toString()}`;
        });
        
        async function loadExcelData(building = 'zorlu') {
            // Excel verilerini sƒ±fƒ±rla
            excelData = {};
            
            // Excel dosya adƒ± her zaman k√º√ß√ºk harfle
            const excelFileName = building.toLowerCase();
            
            try {
                const response = await fetch(`./${excelFileName}.xlsx`);
                if (!response.ok) {
                    console.log(`${excelFileName}.xlsx bulunamadƒ±`);
                    return;
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // T√ºm sheet'leri i≈üle (her sheet bir kat olabilir)
                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);
                    
                    jsonData.forEach(row => {
                        const id = row.ID || row.id || row.Id;
                        const title = row.Title || row.title || row.TITLE || '';
                        const subtitle = row.Subtitle || row.subtitle || row.SUBTITLE || row.SubTitle || '';
                        const floor = row.Floor || row.floor || row.Kat || row.kat || '0';
                        
                        if (id) {
                            if (!excelData[floor]) excelData[floor] = {};
                            excelData[floor][id] = { title, subtitle };
                            
                            // Global olarak da ekle (eski uyumluluk)
                            if (!excelData['all']) excelData['all'] = {};
                            excelData['all'][id] = { title, subtitle, floor };
                        }
                    });
                });
                
                console.log('Excel y√ºklendi');
            } catch (e) {
                console.log('Excel y√ºklenemedi:', e);
            }
        }
        
        function populateFloorSelects() {
            const floors = mapDirection.floorNames;
            const startSelect = document.getElementById('startFloor');
            const endSelect = document.getElementById('endFloor');
            
            const floorLabels = {
                '0': '0',
                '-1': '-1',
                '-2': '-2',
                '1': '1',
                '2': '2'
            };
            
            startSelect.innerHTML = '<option value="">Se√ß</option>';
            endSelect.innerHTML = '<option value="">Se√ß</option>';
            
            floors.forEach(floor => {
                const label = floorLabels[floor] || `Kat ${floor}`;
                
                const opt1 = document.createElement('option');
                opt1.value = floor;
                opt1.textContent = label;
                startSelect.appendChild(opt1);
                
                const opt2 = document.createElement('option');
                opt2.value = floor;
                opt2.textContent = label;
                endSelect.appendChild(opt2);
            });
        }
        
        function onStartFloorChange() {
            const floorId = document.getElementById('startFloor').value;
            populateRoomSelect('startRoom', floorId);
            updateRoutePreview();
        }
        
        function onEndFloorChange() {
            const floorId = document.getElementById('endFloor').value;
            populateRoomSelect('endRoom', floorId);
            updateRoutePreview();
        }
        
        function populateRoomSelect(selectId, floorId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- Birim Se√ßin --</option>';
            
            if (!floorId) return;
            
            const rooms = mapDirection.getRoomsForFloor(floorId);
            
            // ID ile ba≈ülayan odalarƒ± filtrele ve sƒ±rala
            const filteredRooms = rooms
                .filter(r => r.id.startsWith('ID'))
                .sort((a, b) => a.id.localeCompare(b.id));
            
            filteredRooms.forEach(room => {
                // Excel'den e≈üle≈üen veriyi bul
                const floorExcel = excelData[floorId] || excelData['all'] || {};
                const excelInfo = floorExcel[room.id] || (excelData['all'] || {})[room.id];
                
                let displayText;
                if (excelInfo && (excelInfo.title || excelInfo.subtitle)) {
                    const parts = [];
                    if (excelInfo.title) parts.push(excelInfo.title);
                    if (excelInfo.subtitle) parts.push(excelInfo.subtitle);
                    displayText = parts.join(' - ');
                } else {
                    displayText = `${room.id} (${room.type})`;
                }
                
                const opt = document.createElement('option');
                opt.value = room.id;
                opt.textContent = displayText;
                select.appendChild(opt);
            });
        }
        
        function updateRoutePreview() {
            const preview = document.getElementById('routePreview');
            const stepsContainer = document.getElementById('routeSteps');
            
            const startFloor = document.getElementById('startFloor').value;
            const endFloor = document.getElementById('endFloor').value;
            const startRoom = document.getElementById('startRoom').value;
            const endRoom = document.getElementById('endRoom').value;
            
            if (!startFloor || !endFloor || !startRoom || !endRoom) {
                preview.classList.remove('show');
                return;
            }
            
            // Rota hesapla
            const route = mapDirection.calculateMultiFloorRoute(startRoom, startFloor, endRoom, endFloor);
            currentRoute = route;
            
            if (!route) {
                stepsContainer.innerHTML = '<div style="color: red;">Rota bulunamadƒ±!</div>';
                preview.classList.add('show');
                return;
            }
            
            // Rota adƒ±mlarƒ±nƒ± g√∂ster
            let html = '';
            
            // Ba≈ülangƒ±√ß
            html += `
                <div class="route-step">
                    <div class="step-icon start">üìç</div>
                    <div class="step-text">
                        <strong>${getRoomDisplayName(startRoom, startFloor)}</strong>
                        <span class="floor-badge floor-${startFloor}">Kat ${startFloor}</span>
                    </div>
                </div>
            `;
            
            // Kat ge√ßi≈üleri
            if (!route.isSameFloor && route.transitions) {
                route.transitions.forEach((t, i) => {
                    const portalIcon = t.portal.portalType === 'Elev' ? 'üõó' : 'üö∂';
                    const portalName = t.portal.portalType === 'Elev' ? 'Asans√∂r' : 'Merdiven';
                    
                    html += `
                        <div class="route-step">
                            <div class="step-icon portal">${portalIcon}</div>
                            <div class="step-text">
                                ${portalName} ${t.portal.portalNumber} ile Kat ${t.toFloor}'e gidin
                                <span class="floor-badge floor-${t.fromFloor}">Kat ${t.fromFloor}</span>
                                ‚Üí
                                <span class="floor-badge floor-${t.toFloor}">Kat ${t.toFloor}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Hedef
            html += `
                <div class="route-step">
                    <div class="step-icon end">üéØ</div>
                    <div class="step-text">
                        <strong>${getRoomDisplayName(endRoom, endFloor)}</strong>
                        <span class="floor-badge floor-${endFloor}">Kat ${endFloor}</span>
                    </div>
                </div>
            `;
            
            stepsContainer.innerHTML = html;
            preview.classList.add('show');
        }
        
        function getRoomDisplayName(roomId, floorId) {
            const floorExcel = excelData[floorId] || excelData['all'] || {};
            const excelInfo = floorExcel[roomId] || (excelData['all'] || {})[roomId];
            
            if (excelInfo && (excelInfo.title || excelInfo.subtitle)) {
                const parts = [];
                if (excelInfo.title) parts.push(excelInfo.title);
                if (excelInfo.subtitle) parts.push(excelInfo.subtitle);
                return parts.join(' - ');
            }
            return roomId;
        }
    </script>
</body>

</html>
